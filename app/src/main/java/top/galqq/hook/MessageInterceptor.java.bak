package top.galqq.hook;

import android.app.Activity;
import android.content.Context;
import android.graphics.Color;
import android.view.Gravity;
import android.view.View;
import android.view.ViewGroup;
import android.widget.LinearLayout;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;
import java.lang.reflect.Method;
import java.util.List;
import de.robv.android.xposed.XC_MethodHook;
import de.robv.android.xposed.XposedBridge;
import de.robv.android.xposed.XposedHelpers;
import top.galqq.config.ConfigManager;
import top.galqq.utils.AiRequestQueue;
import top.galqq.utils.DictionaryManager;
import top.galqq.utils.HttpAiClient;
import top.galqq.utils.SendMessageHelper;

public class MessageInterceptor {

    private static final String TAG = "GalQQ.MessageInterceptor";
    private static final int OPTION_BAR_ID = 0x7F0A1234; // Custom ID for option bar
    
    // AI选项缓存：msgId -> List<String> options
    private static final java.util.Map<String, java.util.List<String>> optionsCache = 
        new java.util.LinkedHashMap<String, java.util.List<String>>(100, 0.75f, true) {
            @Override
            protected boolean removeEldestEntry(java.util.Map.Entry<String, java.util.List<String>> eldest) {
                return size() > 100; // 最多缓存100条消息的选项
            }
        };

    public static void init(ClassLoader classLoader) {
        // Detect QQ architecture and use appropriate hook strategy
        if (top.galqq.utils.QQNTUtils.isQQNT(classLoader)) {
            XposedBridge.log(TAG + ": Detected QQNT, using QQNT hook strategy");
            hookAIOBubbleMsgItemVB(classLoader);  // QQNT architecture
        } else {
            XposedBridge.log(TAG + ": Detected legacy QQ, using TextItemBuilder hook strategy");
            hookTextItemBuilder(classLoader);      // Legacy QQ architecture
        }
    }

    private static void hookTextItemBuilder(ClassLoader classLoader) {
        try {
            // Try more indices to handle different QQ versions
            Class<?> textItemBuilderClass = top.galqq.utils.ReflectionUtils.findClassWithSynthetics(
                "com.tencent.mobileqq.activity.aio.item.TextItemBuilder", 
                classLoader,
                10, 7, 6, 3, 8, 1, 2, 4, 5, 9, 11, 12, 13, 14, 15
            );
            
            if (textItemBuilderClass == null) {
                XposedBridge.log(TAG + ": TextItemBuilder class not found, skipping hook");
                return;
            }
            
            XposedBridge.log(TAG + ": Found TextItemBuilder class: " + textItemBuilderClass.getName());
            
            // Find the target method
            Method targetMethod = null;
            String methodName = null;
            
            // Try both method names
            for (String name : new String[]{"F", "a"}) {
                for (Method m : textItemBuilderClass.getDeclaredMethods()) {
                    if (!m.getName().equals(name)) continue;
                    if (!View.class.isAssignableFrom(m.getReturnType())) continue;
                    
                    Class<?>[] params = m.getParameterTypes();
                    if (params.length == 5 && 
                        View.class.isAssignableFrom(params[2]) && 
                        ViewGroup.class.isAssignableFrom(params[3])) {
                        targetMethod = m;
                        methodName = name;
                        break;
                    }
                }
                if (targetMethod != null) break;
            }

            if (targetMethod == null) {
                XposedBridge.log(TAG + ": Failed to find target method in TextItemBuilder");
                return;
            }
            
            XposedBridge.log(TAG + ": Found target method: " + methodName);
            
            // Hook the method using QQ's approach (modify BaseChatItemLayout directly)
            XposedBridge.hookMethod(targetMethod, new XC_MethodHook() {
                @Override
                protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                    try {
                        Object chatMessage = param.args[0];
                        RelativeLayout baseChatItemLayout = (RelativeLayout) param.args[3];
                        
                        if (baseChatItemLayout == null) return;
                        
                        Context context = baseChatItemLayout.getContext();
                        ConfigManager.init(context);
                        
                        if (!ConfigManager.isModuleEnabled()) return;

                        boolean isSend = XposedHelpers.getBooleanField(chatMessage, "isSend");
                        if (isSend) return;
                        
                        // 如果选项条已存在，总是更新内容（解决视图复用导致的内容混乱）
                        if (baseChatItemLayout.findViewById(OPTION_BAR_ID) != null) {
                            LinearLayout existingBar = baseChatItemLayout.findViewById(OPTION_BAR_ID);
                            existingBar.removeAllViews();
                            String msgContent = (String) XposedHelpers.getObjectField(chatMessage, "msg");
                            setupOptionBarContent(context, existingBar, msgContent, chatMessage, null);
                            return;
                        }
                        
                        LinearLayout optionBar = createOptionBar(context, chatMessage);
                        optionBar.setId(OPTION_BAR_ID);
                        
                        // 获取屏幕宽度
                        int screenWidth = context.getResources().getDisplayMetrics().widthPixels;
                        int barWidth = screenWidth - dp2px(context, 24); // 左8+右16=24dp
                        
                        XposedBridge.log(TAG + ": Screen width=" + screenWidth + ", bar width=" + barWidth);
                        
                        RelativeLayout.LayoutParams params = new RelativeLayout.LayoutParams(
                            barWidth, // 使用计算出的具体宽度
                            ViewGroup.LayoutParams.WRAP_CONTENT
                        );
                        params.addRule(RelativeLayout.ALIGN_PARENT_LEFT);
                        params.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);
                        params.leftMargin = dp2px(context, 8);  // 左边距8dp
                        params.rightMargin = dp2px(context, 16); // 右边距16dp（冗余但保留）
                        params.bottomMargin = dp2px(context, 5);
                        
                        baseChatItemLayout.addView(optionBar, params);
                        
                        XposedBridge.log(TAG + ": Successfully added option bar to BaseChatItemLayout");
                        
                    } catch (Throwable t) {
                        XposedBridge.log(TAG + ": Error in afterHook: " + t.getMessage());
                    }
                }
            });
            
            XposedBridge.log(TAG + ": ✓ Successfully hooked TextItemBuilder." + methodName);
            
        } catch (Throwable t) {
            XposedBridge.log(TAG + ": Failed to hook TextItemBuilder: " + t.getMessage());
        }
    }

    private static LinearLayout createOptionBar(Context context, Object chatMessage) {
        LinearLayout bar = new LinearLayout(context);
        bar.setOrientation(LinearLayout.VERTICAL);
        bar.setGravity(Gravity.LEFT);
        bar.setPadding(0, dp2px(context, 5), 0, dp2px(context, 5));
        
        String msgContent = (String) XposedHelpers.getObjectField(chatMessage, "msg");
        setupOptionBarContent(context, bar, msgContent, chatMessage, null);
        return bar;
    }
    
    private static void updateOptionBar(Context context, LinearLayout bar, Object chatMessage) {
        String msgContent = (String) XposedHelpers.getObjectField(chatMessage, "msg");
        bar.removeAllViews();
        setupOptionBarContent(context, bar, msgContent, chatMessage, null);
    }

    private static void setupOptionBarContent(Context context, LinearLayout bar, String msgContent, Object msgObj, String msgId) {
        if (ConfigManager.isAiEnabled()) {
            // AI模式：调用AI并缓存结果
            HttpAiClient.fetchOptions(context, msgContent, new HttpAiClient.AiCallback() {
                @Override
                public void onSuccess(List<String> options) {
                    if (context instanceof Activity) {
                        ((Activity) context).runOnUiThread(() -> {
                            // 缓存AI结果（仅在AI模式下缓存）
                            if (msgId != null) {
                                optionsCache.put(msgId, new java.util.ArrayList<>(options));
                                XposedBridge.log(TAG + ": Cached AI options for msgId=" + msgId);
                            }
                            populateBarAndShow(context, bar, options, msgObj);
                        });
                    }
                }

                @Override
                public void onFailure(Exception e) {
                    // AI失败时隐藏选项条
                    if (context instanceof Activity) {
                        ((Activity) context).runOnUiThread(() -> {
                            bar.setVisibility(View.GONE);
                        });
                    }
                }
            });
        } else {
            // 本地词库模式：每次随机生成，不使用缓存
            useDictionaryNT(context, bar, msgObj);
        }
    }

    private static void useDictionary(Context context, LinearLayout bar, Object chatMessage) {
        DictionaryManager.loadDictionary(context);
        List<String> options = DictionaryManager.pickRandomLines(3);
        populateBarAndShow(context, bar, options, chatMessage);
    }

    // 填充选项条并显示（如果有选项的话）
    private static void populateBarAndShow(Context context, LinearLayout bar, List<String> options, Object chatMessage) {
        bar.removeAllViews();
        
        if (options == null || options.isEmpty()) {
            bar.setVisibility(View.GONE); // 没有选项时隐藏
            return;
        }
        
        for (String option : options) {
            TextView tv = new TextView(context);
            tv.setText(option);
            tv.setTextSize(13);
            tv.setPadding(dp2px(context, 12), dp2px(context, 8), dp2px(context, 12), dp2px(context, 8));
            tv.setBackground(getRoundedBackground(Color.parseColor("#F2F2F2"), dp2px(context, 12)));
            tv.setTextColor(Color.BLACK);
            
            int screenWidth = context.getResources().getDisplayMetrics().widthPixels;
            int maxWidth = screenWidth - dp2px(context, 16);
            
            LinearLayout.LayoutParams lp = new LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.WRAP_CONTENT, ViewGroup.LayoutParams.WRAP_CONTENT
            );
            lp.setMargins(0, 0, 0, dp2px(context, 6));
            tv.setMaxWidth(maxWidth);
            tv.setLayoutParams(lp);
            tv.setGravity(Gravity.CENTER_VERTICAL);
            
            tv.setOnClickListener(v -> {
                sendMessage(context, option, chatMessage);
            });
            
            bar.addView(tv);
        }
        
        bar.setVisibility(View.VISIBLE); // 有选项时显示
    }


    private static void sendMessage(Context context, String text, Object originMsg) {
        try {
            // Check if it's QQNT MsgRecord
            if (originMsg.getClass().getName().contains("qqnt")) {
                // Use SendMessageHelper for QQNT
                SendMessageHelper.sendMessageNT(context, originMsg, text);
                return;
            }

            Class<?> baseAppClass = XposedHelpers.findClass(
                "com.tencent.common.app.BaseApplicationImpl", 
                context.getClassLoader()
            );
            Object app = XposedHelpers.callStaticMethod(baseAppClass, "getApplication");
            Object runtime = XposedHelpers.callMethod(app, "getRuntime");
            
            Class<?> sessionInfoClass = XposedHelpers.findClass(
                "com.tencent.mobileqq.activity.aio.SessionInfo", 
                context.getClassLoader()
            );
            Object session = sessionInfoClass.newInstance();
            
            int istroop = XposedHelpers.getIntField(originMsg, "istroop");
            String frienduin = (String) XposedHelpers.getObjectField(originMsg, "frienduin");
            
            XposedHelpers.setIntField(session, "curType", istroop);
            XposedHelpers.setObjectField(session, "curFriendUin", frienduin);
            
            Class<?> facadeClass = XposedHelpers.findClass(
                "com.tencent.mobileqq.activity.ChatActivityFacade", 
                context.getClassLoader()
            );
            XposedHelpers.callStaticMethod(facadeClass, "sendMessage", runtime, session, text);
            
            Toast.makeText(context, "已发送: " + text, Toast.LENGTH_SHORT).show();
            
        } catch (Exception e) {
            XposedBridge.log(TAG + ": Failed to send message: " + e.getMessage());
            Toast.makeText(context, "发送失败: " + e.getMessage(), Toast.LENGTH_SHORT).show();
        }
    }
    
    // ========== QQNT Architecture Hook ==========
    
    private static void hookAIOBubbleMsgItemVB(ClassLoader classLoader) {
        try {
            Class<?> kAIOBubbleMsgItemVB = Class.forName(
                "com.tencent.mobileqq.aio.msglist.holder.AIOBubbleMsgItemVB",
                false,
                classLoader
            );
            
            Class<?> kAIOMsgItem = Class.forName("com.tencent.mobileqq.aio.msg.AIOMsgItem", false, classLoader);
            Method getMsgRecord = kAIOMsgItem.getMethod("getMsgRecord");
            
            // 1. Try to find handleUIState (Newer QQNT)
            Method handleUIState = null;
            try {
                for (Method m : kAIOBubbleMsgItemVB.getDeclaredMethods()) {
                    if ("handleUIState".equals(m.getName())) {
                        handleUIState = m;
                        break;
                    }
                }
            } catch (Exception e) {}

            if (handleUIState != null) {
                XposedBridge.log(TAG + ": Found handleUIState method");
                XposedBridge.hookMethod(handleUIState, new XC_MethodHook() {
                    @Override
                    protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                        Object uiState = param.args[0];
                        if (uiState == null) return;
                        
                        // QAuxiliary calls "b()" on uiState to get msgItem
                        Object msgItem = null;
                        try {
                            Method b = uiState.getClass().getMethod("b");
                            b.setAccessible(true);
                            msgItem = b.invoke(uiState);
                        } catch (Exception e) {
                            // Fallback: search for method returning AIOMsgItem
                            for (Method m : uiState.getClass().getDeclaredMethods()) {
                                if (m.getParameterCount() == 0 && kAIOMsgItem.isAssignableFrom(m.getReturnType())) {
                                    m.setAccessible(true);
                                    msgItem = m.invoke(uiState);
                                    break;
                                }
                            }
                        }
                        
                        if (msgItem == null) return;
                        
                        processQQNTMessage(param.thisObject, msgItem, getMsgRecord);
                    }
                });
                return;
            }

            // 2. Fallback to bind method (Older QQNT)
            Method bindMethod = null;
            for (Method m : kAIOBubbleMsgItemVB.getDeclaredMethods()) {
                Class<?>[] params = m.getParameterTypes();
                if (m.getReturnType() == Void.TYPE && params.length == 4) {
                    // Check params: int, AIOMsgItem(or super), List, Bundle
                    if (params[0] == Integer.TYPE && 
                        params[1].isAssignableFrom(kAIOMsgItem) && // Check if params[1] is super of AIOMsgItem
                        params[2] == List.class &&
                        params[3] == android.os.Bundle.class) {
                        bindMethod = m;
                        break;
                    }
                }
            }
            
            if (bindMethod != null) {
                XposedBridge.log(TAG + ": Found bind method");
                XposedBridge.hookMethod(bindMethod, new XC_MethodHook() {
                    @Override
                    protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                        Object msgItem = param.args[1];
                        processQQNTMessage(param.thisObject, msgItem, getMsgRecord);
                    }
                });
                return;
            }
            
            XposedBridge.log(TAG + ": Failed to find handleUIState or bind method in AIOBubbleMsgItemVB");

        } catch (Throwable t) {
            XposedBridge.log(TAG + ": Error in hookAIOBubbleMsgItemVB: " + t.getMessage());
            XposedBridge.log(t);
        }
    }

    private static void processQQNTMessage(Object aioBubbleMsgItemVB, Object msgItem, Method getMsgRecord) {
        try {
            // Get MsgRecord
            Object msgRecord = getMsgRecord.invoke(msgItem);
            
            // Get root ViewGroup via getHostView
            Method getHostView = aioBubbleMsgItemVB.getClass().getMethod("getHostView");
            ViewGroup rootView = (ViewGroup) getHostView.invoke(aioBubbleMsgItemVB);
            
            if (rootView == null || msgRecord == null) return;
            
            Context context = rootView.getContext();
            ConfigManager.init(context);
            
            // Check if module is enabled
            if (!ConfigManager.isModuleEnabled()) {
                return; // Module is disabled, don't show option bar
            }
            
            // Check if it's a received message
            int sendType = XposedHelpers.getIntField(msgRecord, "sendType");
            if (sendType != 0) return; // Not a received message

            // Filter out unwanted message types
            int msgType = XposedHelpers.getIntField(msgRecord, "msgType");
            // 5 = Gray Tips (Revoke), 3 = File, 7 = Video
            if (msgType == 5 || msgType == 3 || msgType == 7) {
                return;
            }

            // Filter out messages with no text content (e.g. pure images, stickers)
            String msgContent = getMessageContentNT(msgRecord);
            if (msgContent.isEmpty()) {
                return;
            }
            
            // 【关键修复】无条件清理旧选项条（RecyclerView的ViewHolder会复用）
            LinearLayout existingBar = rootView.findViewById(OPTION_BAR_ID);
            if (existingBar != null) {
                rootView.removeView(existingBar);
            }
            
            // 黑白名单过滤
            try {
                Object senderUinObj = XposedHelpers.getObjectField(msgRecord, "senderUin");
                String senderUin = String.valueOf(senderUinObj);
                String filterMode = ConfigManager.getFilterMode();
                
                // XposedBridge.log(TAG + ": Filter - senderUin=" + senderUin + ", mode=" + filterMode);
                
                if ("blacklist".equals(filterMode)) {
                    if (ConfigManager.isInBlacklist(senderUin)) {
                        // XposedBridge.log(TAG + ": ✗ BLOCKED by blacklist: " + senderUin);
                        return; // 不通过过滤，不添加选项条
                    }
                } else if ("whitelist".equals(filterMode)) {
                    if (!ConfigManager.isInWhitelist(senderUin)) {
                        // XposedBridge.log(TAG + ": ✗ BLOCKED by whitelist (not in list): " + senderUin);
                        return; // 不通过过滤，不添加选项条
                    }
                }
                // XposedBridge.log(TAG + ": ✓ PASSED filter: " + senderUin);
            } catch (Throwable t) {
                XposedBridge.log(TAG + ": Error filtering by list: " + t.getMessage());
                XposedBridge.log(t);
                return; // 过滤失败时不添加选项条
            }
            
            // 获取消息ID（用于AI缓存，不用于View管理）
            String msgId = null;
            try {
                Object msgIdObj = XposedHelpers.getObjectField(msgRecord, "msgId");
                msgId = String.valueOf(msgIdObj);
            } catch (Throwable t) {
                XposedBridge.log(TAG + ": Failed to get msgId: " + t.getMessage());
            }
            
            // 创建新选项条（每次都重新创建，不复用View）
            LinearLayout optionBar = createEmptyOptionBarNT(context);
            optionBar.setId(OPTION_BAR_ID);
            
            // 先添加选项条到布局（空的，稍后异步填充内容）
            // XposedBridge.log(TAG + ": RootView class: " + rootView.getClass().getName());
            Class<?> constraintLayoutClass = null;
            try {
                constraintLayoutClass = XposedHelpers.findClass("androidx.constraintlayout.widget.ConstraintLayout", context.getClassLoader());
            } catch (Throwable t) {
                // Ignore if class not found
            }

            if (constraintLayoutClass != null && constraintLayoutClass.isAssignableFrom(rootView.getClass())) {
                // XposedBridge.log(TAG + ": RootView is a ConstraintLayout (or subclass)");
                handleConstraintLayout(context, rootView, optionBar, msgRecord);
            } else if (rootView.getClass().getName().contains("ConstraintLayout")) {
                // XposedBridge.log(TAG + ": RootView name contains ConstraintLayout");
                handleConstraintLayout(context, rootView, optionBar, msgRecord);
            } else {
                // XposedBridge.log(TAG + ": RootView is NOT identified as ConstraintLayout, using legacy handler");
                handleLegacyLayout(context, rootView, optionBar);
            }
            
            // 填充选项条内容（本地词库或AI）
            fillOptionBarContent(context, optionBar, msgRecord, msgId);
            
            // XposedBridge.log(TAG + ": Successfully added option bar to QQNT message");

        } catch (Throwable t) {
            XposedBridge.log(TAG + ": Error processing QQNT message: " + t.getMessage());
            XposedBridge.log(t);
        }
    }

    private static void handleLegacyLayout(Context context, ViewGroup rootView, View optionBar) {
        ViewGroup.LayoutParams lp;
        if (rootView instanceof RelativeLayout) {
            RelativeLayout.LayoutParams rlp = new RelativeLayout.LayoutParams(
                ViewGroup.LayoutParams.WRAP_CONTENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
            );
            rlp.addRule(RelativeLayout.ALIGN_PARENT_LEFT);
            rlp.addRule(RelativeLayout.ALIGN_PARENT_BOTTOM);
            rlp.leftMargin = dp2px(context, 15);
            rlp.bottomMargin = dp2px(context, 5);
            lp = rlp;
        } else if (rootView instanceof android.widget.FrameLayout) {
            android.widget.FrameLayout.LayoutParams flp = new android.widget.FrameLayout.LayoutParams(
                ViewGroup.LayoutParams.WRAP_CONTENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
            );
            flp.gravity = Gravity.BOTTOM | Gravity.LEFT;
            flp.leftMargin = dp2px(context, 15);
            flp.bottomMargin = dp2px(context, 5);
            lp = flp;
        } else {
            ViewGroup.MarginLayoutParams mlp = new ViewGroup.MarginLayoutParams(
                ViewGroup.LayoutParams.WRAP_CONTENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
            );
            mlp.leftMargin = dp2px(context, 15);
            lp = mlp;
        }
        rootView.addView(optionBar, lp);
    }

    private static void handleConstraintLayout(Context context, ViewGroup rootView, View optionBar, Object msgRecord) {
        try {
            // 1. Add view to ConstraintLayout first (needed for ConstraintSet to work)
            // 使用MATCH_CONSTRAINT(0)让宽度由约束决定
            // XposedBridge.log(TAG + ": Creating LayoutParams with MATCH_CONSTRAINT");
            
            // Use ConstraintLayout.LayoutParams if possible
            Class<?> constraintLayoutParamsClass = XposedHelpers.findClass("androidx.constraintlayout.widget.ConstraintLayout$LayoutParams", context.getClassLoader());
            ViewGroup.LayoutParams clp = (ViewGroup.LayoutParams) constraintLayoutParamsClass.getConstructor(int.class, int.class)
                .newInstance(0, ViewGroup.LayoutParams.WRAP_CONTENT); // 宽度0 = MATCH_CONSTRAINT
            
            rootView.addView(optionBar, clp);
            
            // 2. Use ConstraintSet to position it
            Class<?> constraintSetClass = XposedHelpers.findClass("androidx.constraintlayout.widget.ConstraintSet", context.getClassLoader());
            Object constraintSet = constraintSetClass.newInstance();
            Class<?> constraintLayoutClass = rootView.getClass();
            
            // clone(ConstraintLayout)
            XposedHelpers.callMethod(constraintSet, "clone", rootView);
            
            // Find anchor views (Message Bubble)
            int msgBubbleId = -1;

            // 1. BubbleLayout Class Name Search (Priority)
            // XposedBridge.log(TAG + ": Trying to find bubble via BubbleLayout class name...");
            for (int i = 0; i < rootView.getChildCount(); i++) {
                View child = rootView.getChildAt(i);
                if (child.getClass().getName().contains("BubbleLayout") && child.getId() != View.NO_ID) {
                    msgBubbleId = child.getId();
                    // XposedBridge.log(TAG + ": Found bubble via class name, ID: " + msgBubbleId);
                    break;
                }
            }

            // 2. Text Content Search (Fallback)
            if (msgBubbleId == -1) {
                String msgContent = getMessageContentNT(msgRecord);
                if (!msgContent.isEmpty()) {
                    XposedBridge.log(TAG + ": BubbleLayout not found, trying text content: " + msgContent);
                    View textContainer = findViewWithText(rootView, msgContent);
                    if (textContainer != null) {
                        View bubble = textContainer;
                        while (bubble.getParent() != rootView && bubble.getParent() instanceof View) {
                            bubble = (View) bubble.getParent();
                        }
                        
                        if (bubble.getParent() == rootView && bubble.getId() != View.NO_ID) {
                            msgBubbleId = bubble.getId();
                            XposedBridge.log(TAG + ": Found bubble via text content, ID: " + msgBubbleId + ", Class: " + bubble.getClass().getName());
                        }
                    }
                }
            }

            // 3. LinearLayout Fallback (Last Resort)
            if (msgBubbleId == -1) {
                XposedBridge.log(TAG + ": Text search failed, trying LinearLayout fallback...");
                for (int i = 0; i < rootView.getChildCount(); i++) {
                    View child = rootView.getChildAt(i);
                    if (child instanceof LinearLayout && child.getId() != View.NO_ID) {
                        msgBubbleId = child.getId();
                        XposedBridge.log(TAG + ": Found bubble via LinearLayout fallback, ID: " + msgBubbleId);
                        break;
                    }
                }
            }
            
            if (msgBubbleId != -1) {
                // Connect TOP of OptionBar to BOTTOM of MessageBubble
                // connect(int startID, int startSide, int endID, int endSide, int margin)
                // Sides: TOP=3, BOTTOM=4, LEFT=1, RIGHT=2, START=6, END=7
                int TOP = 3, BOTTOM = 4, LEFT = 1, RIGHT = 2, START = 6, END = 7;
                
                XposedHelpers.callMethod(constraintSet, "connect", 
                    OPTION_BAR_ID, TOP, msgBubbleId, BOTTOM, dp2px(context, 5));
                
                // Align START (Left) of OptionBar to START (Left) of MessageBubble with 8dp margin
                // 向左移动选项条
                XposedHelpers.callMethod(constraintSet, "connect", 
                    OPTION_BAR_ID, START, msgBubbleId, START, dp2px(context, 8)); // 8dp左边距
                
                // 限制右边界到parent的END，留16dp margin
                XposedHelpers.callMethod(constraintSet, "connect",
                    OPTION_BAR_ID, END, 0 /* PARENT_ID */, END, dp2px(context, 16)); // 16dp右边距
                
                // Apply constraints
                XposedHelpers.callMethod(constraintSet, "applyTo", rootView);
                // XposedBridge.log(TAG + ": Applied ConstraintSet layout with margins");
            } else {
                XposedBridge.log(TAG + ": Could not find message bubble ID for ConstraintLayout");
            }
            
        } catch (Exception e) {
            XposedBridge.log(TAG + ": Error handling ConstraintLayout: " + e.getMessage());
            XposedBridge.log(e);
            // Fallback to simple add if failed
            if (optionBar.getParent() == null) {
                rootView.addView(optionBar);
            }
        }
    }

    // Helper to find view with text
    private static View findViewWithText(ViewGroup root, String text) {
        for (int i = 0; i < root.getChildCount(); i++) {
            View child = root.getChildAt(i);
            if (child instanceof TextView) {
                String viewText = ((TextView) child).getText().toString();
                // Check if viewText contains the msgContent (or vice versa, to be safe)
                if (viewText.contains(text) || text.contains(viewText)) {
                    return child;
                }
            } else if (child instanceof ViewGroup) {
                View found = findViewWithText((ViewGroup) child, text);
                if (found != null) return found;
            }
        }
        return null;
    }
    
    // 创建空的选项条（稍后填充内容）
    private static LinearLayout createEmptyOptionBarNT(Context context) {
        LinearLayout bar = new LinearLayout(context);
        bar.setOrientation(LinearLayout.VERTICAL);
        bar.setGravity(Gravity.LEFT);
        bar.setPadding(0, dp2px(context, 5), 0, dp2px(context, 5));
        bar.setVisibility(View.GONE); // 初始隐藏，等有内容后再显示
        return bar;
    }
    
    // 填充选项条内容（AI或本地词库）
    private static void fillOptionBarContent(Context context, LinearLayout bar, Object msgRecord, String msgId) {
        String msgContent = getMessageContentNT(msgRecord);
        
        // 【AI缓存优化】如果启用AI且缓存中有选项，直接使用缓存数据
        if (ConfigManager.isAiEnabled() && msgId != null && optionsCache.containsKey(msgId)) {
            // XposedBridge.log(TAG + ": ✓ Using cached AI options for msgId=" + msgId);
            List<String> cachedOptions = optionsCache.get(msgId);
            populateBarAndShow(context, bar, cachedOptions, msgRecord);
            return;
        }
        
        // 否则重新获取选项（AI或本地词库）
        setupOptionBarContent(context, bar, msgContent, msgRecord, msgId);
    }
    
    private static void useDictionaryNT(Context context, LinearLayout bar, Object msgRecord) {
        DictionaryManager.loadDictionary(context);
        List<String> options = DictionaryManager.pickRandomLines(3);
        populateBarAndShow(context, bar, options, msgRecord);
    }
    
    private static String getMessageContentNT(Object msgRecord) {
        try {
            List<?> elements = (List<?>) XposedHelpers.getObjectField(msgRecord, "elements");
            if (elements == null || elements.isEmpty()) {
                return "";
            }
            
            StringBuilder content = new StringBuilder();
            for (Object element : elements) {
                Object textElement = XposedHelpers.getObjectField(element, "textElement");
                if (textElement != null) {
                    String text = (String) XposedHelpers.getObjectField(textElement, "content");
                    if (text != null) {
                        content.append(text);
                    }
                }
            }
            
            return content.toString();
        } catch (Exception e) {
            XposedBridge.log(TAG + ": Failed to extract message content: " + e.getMessage());
            return "";
        }
    }

    // Helper method for DP to PX conversion
    private static int dp2px(Context context, float dp) {
        final float scale = context.getResources().getDisplayMetrics().density;
        return (int) (dp * scale + 0.5f);
    }

    // Helper to create rounded background
    private static android.graphics.drawable.Drawable getRoundedBackground(int color, int radiusPx) {
        android.graphics.drawable.GradientDrawable drawable = new android.graphics.drawable.GradientDrawable();
        drawable.setShape(android.graphics.drawable.GradientDrawable.RECTANGLE);
        drawable.setColor(color);
        drawable.setCornerRadius(radiusPx);
        return drawable;
    }
}
